package com.example.turf.service;

import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import com.example.turf.exception.InternalServerException;
import com.example.turf.exception.ResourceNotFoundException;
import com.example.turf.model.Turf;
import com.example.turf.repository.TurfRepository;

import javax.sql.rowset.serial.SerialBlob;
import java.io.IOException;
import java.math.BigDecimal;
import java.sql.Blob;
import java.sql.SQLException;
import java.time.LocalDate;
import java.util.List;
import java.util.Optional;

@Service
@RequiredArgsConstructor
public class TurfService implements ITurfService {
    
    private final TurfRepository turfRepository;

    @Override
    public Turf addNewTurf(MultipartFile file, String turfType, BigDecimal turfPrice) throws SQLException, IOException {
        Turf turf = new Turf();
        turf.setTurfType(turfType);
        turf.setTurfPrice(turfPrice);

        if (!file.isEmpty()) {
            byte[] photoBytes = file.getBytes();
            Blob photoBlob = new SerialBlob(photoBytes);
            turf.setPhoto(photoBlob);
        }

        return turfRepository.save(turf);
    }

    @Override
    public List<String> getAllTurfTypes() {
        return turfRepository.findDistinctTurfTypes();
    }

    @Override
    public List<Turf> getAllTurfs() {
        return turfRepository.findAll();
    }

    @Override
    public byte[] getTurfPhotoById(Long turfId) throws SQLException {
        Optional<Turf> theTurf = turfRepository.findById(turfId);
        if (theTurf.isEmpty()) {
            throw new ResourceNotFoundException("Sorry, Turf not found!");
        }
        Blob photoBlob = theTurf.get().getPhoto();
        if (photoBlob != null) {
            return photoBlob.getBytes(1, (int) photoBlob.length());
        }
        return null;
    }

    @Override
    public void deleteTurf(Long turfId) {
        Optional<Turf> theTurf = turfRepository.findById(turfId);
        if (theTurf.isPresent()) {
            turfRepository.deleteById(turfId);
        }
    }

    @Override
    public Turf updateTurf(Long turfId, String turfType, BigDecimal turfPrice, byte[] photoBytes) {
        Turf turf = turfRepository.findById(turfId)
                .orElseThrow(() -> new ResourceNotFoundException("Turf not found with ID: " + turfId));

        if (turfType != null) turf.setTurfType(turfType);
        if (turfPrice != null) turf.setTurfPrice(turfPrice);

        if (photoBytes != null && photoBytes.length > 0) {
            try {
                turf.setPhoto(new SerialBlob(photoBytes));
            } catch (SQLException ex) {
                throw new InternalServerException("Failed to update turf photo.");
            }
        }

        return turfRepository.save(turf);
    }

    @Override
    public Optional<Turf> getTurfById(Long turfId) {
        return turfRepository.findById(turfId);
    }

    @Override
    public List<Turf> getAvailableTurfs(LocalDate checkInDate, LocalDate checkOutDate, String turfType) {
        return turfRepository.findAvailableTurfsByDatesAndType(checkInDate, checkOutDate, turfType);
    }
}
